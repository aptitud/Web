<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">

    <script type="text/javascript" src="test.js"></script>
    <script type="text/javascript" src="../script/jquery-1.8.1.min.js"></script>
    <script type="text/javascript" src="../script/grid.js"></script>
    <script type="text/javascript" src="../script/animation.js"></script>

    <style type="text/css">
        .aptitud-grid {
        }
    </style>
</head>
<body style="width: 100%; height: 100%; overflow: hidden;">
<script type="text/javascript">
    var assertCentered = function(cell) {
        var offs = $(cell).offset();
        var size = {width: $(cell).width(), height: $(cell).height() };

        assertApproximatelyEquals(Math.round($(window).width() / 2), Math.round(offs.left + size.width / 2), 1);
        assertApproximatelyEquals(Math.round($(window).height() / 2), Math.round(offs.top + size.height / 2), 1);
    };

    var GridTest_ = {
        setUp:function () {
            this._grid = new Grid(document.body);
            this._grid.fitToContainer();
        },

        tearDown:function () {
            this._grid.remove();
        },

        testGridLayerShouldBeAddedToContainer:function () {
            var gridLayer = this._grid.getGridLayer();
            var childNodes = document.body.childNodes;
            var foundAsChild = false;

            for (var i = 0; i < childNodes.length && !foundAsChild; i++) {
                foundAsChild = (childNodes[i] == gridLayer);
            }

            assertTrue(foundAsChild);
        },

        testGridLayerShouldHaveAbsolutePosition:function () {
            assertEquals("absolute", this._grid.getGridLayer().style.position);
        },

        testGridShouldSpanEntireContainer:function () {
            assertEquals(0, parseInt(this._grid.getGridLayer().style.left));
            assertEquals(0, parseInt(this._grid.getGridLayer().style.top));
            assertEquals($(window).width(), $(this._grid.getGridLayer()).width());
            assertEquals($(window).height(), $(this._grid.getGridLayer()).height());
        },

        testGridShouldHaveClassName:function () {
            assertTrue(this._grid.getGridLayer().className.indexOf("aptitud-grid") >= 0);
        },

        testDimensionsShouldInitiallyBeZero:function () {
            var dimensions = this._grid.getDimensions();

            assertEquals(0, dimensions.columns);
            assertEquals(0, dimensions.rows);
        },

        testSetCellContentsShouldUpdateDimensions:function () {
            this._grid.setCellContent(0, 0, document.createElement("div"));

            var dimensions = this._grid.getDimensions();
            assertEquals(1, dimensions.columns);
            assertEquals(1, dimensions.rows);
        },

        testSingleCellShouldSpanEntireGridIfZeroPadding:function () {
            var cellContent = document.createElement("div");

            this._grid.setCellContent(0, 0, cellContent);

            assertEquals(0, parseInt(cellContent.style.left));
            assertEquals(0, parseInt(cellContent.style.top));
            assertEquals(parseInt(this._grid.getGridLayer().style.width), parseInt(cellContent.style.width));
            assertEquals(parseInt(this._grid.getGridLayer().style.height), parseInt(cellContent.style.height));
        },

        testDefaultCellSizeInOptions:function () {
            this._grid.getDimensions = function () {
                return {columns:2, rows:3};
            };

            var cellSize = this._grid._options.getCellSize();

            assertEquals($(this._grid.getGridLayer()).width() / 2, cellSize.width);
            assertEquals($(this._grid.getGridLayer()).height() / 3, cellSize.height);
        },

        testLayoutMultipleCellsWithCellSpacings:function () {
            var cell00 = document.createElement("div");
            var cell10 = document.createElement("div");
            var cell01 = document.createElement("div");
            var cell11 = document.createElement("div");

            cell00.style.background = "blue";
            cell10.style.background = "green";
            cell01.style.background = "yellow";
            cell11.style.background = "orange";

            this._grid.setCellContent(0, 0, cell00);
            this._grid.setCellContent(1, 0, cell10);
            this._grid.setCellContent(0, 1, cell01);
            this._grid.setCellContent(1, 1, cell11);

            for (var cellSpacing = 0; cellSpacing <= 3; cellSpacing++) {
                this._grid.setOptions({cellSpacing:cellSpacing});

                assertEquals(0, $(cell00).position().left);
                assertEquals(0, $(cell00).position().top);
                assertEquals($(cell00).width() + cellSpacing, $(cell10).position().left);
                assertEquals(0, $(cell10).position().top);
                assertEquals(0, $(cell01).position().left);
                assertEquals($(cell00).height() + cellSpacing, $(cell01).position().top);
                assertEquals($(cell01).width() + cellSpacing, $(cell11).position().left);
                assertEquals($(cell10).height() + cellSpacing, $(cell11).position().top);
            }
        },

        testCellsShouldGetAbsolutePositioning:function () {
            var cell = document.createElement("div");

            this._grid.setCellContent(0, 0, cell);

            assertEquals("absolute", cell.style.position);
        },

        testDefaultCellSizeShouldConsiderCellSpacing:function () {
            this._grid.getDimensions = function () {
                return {columns:2, rows:3};
            };

            this._grid.setOptions({ cellSpacing:1 });

            var expectedCellWidth = $(this._grid.getGridLayer()).width() / 2 - 1;
            var expectedCellHeight = $(this._grid.getGridLayer()).height() / 3 - 2;

            var actualCellSize = this._grid._options.getCellSize();

            assertEquals(expectedCellWidth, actualCellSize.width);
            assertEquals(expectedCellHeight, actualCellSize.height);
        },

        testSelectedCellShouldInitiallyBeNull:function () {
            assertEquals(null, this._grid.getSelectedCell());
        },

        testSetSelectedCellShouldFireEvent:function () {
            var callbackInvoked = false;

            this._grid.setCellContent(0, 0, document.createElement("div"));
            this._grid.setOptions({onCellSelected:function () {
                callbackInvoked = true;
            }});
            this._grid.setSelectedCell({ column:0, row:0 })

            assertTrue(callbackInvoked);
            assertEquals(0, this._grid.getSelectedCell().column);
            assertEquals(0, this._grid.getSelectedCell().row);
        },

        testSelectedCellShouldValidateLocation:function () {
            try {
                this._grid.setSelectedCell({ column:1, row:0 });
                fail("Expected exception");
            } catch (e) {
            }
        },

        testOverflowShouldBeHiddenBySelectedCellLayout: function() {
            this._grid.selectedCellVisible({});
            assertEquals("hidden", document.body.style.overflow);
        },

        testSelectedCellLayout:function () {
            var cell00 = document.createElement("div");
            var cell10 = document.createElement("div");
            var cell01 = document.createElement("div");
            var cell11 = document.createElement("div");

            cell00.style.background = "blue";
            cell10.style.background = "green";
            cell01.style.background = "yellow";
            cell11.style.background = "orange";

            this._grid.setCellContent(0, 0, cell00);
            this._grid.setCellContent(1, 0, cell10);
            this._grid.setCellContent(0, 1, cell01);
            this._grid.setCellContent(1, 1, cell11);

            for (var peakAmount = 0; peakAmount <= 20; peakAmount += 2) {
                for (var cellSpacing = 0; cellSpacing <= 5; cellSpacing++) {
                    this._grid.selectedCellVisible({ peakAmount:peakAmount });
                    this._grid.setOptions({cellSpacing: cellSpacing});

                    var cellSize = this._grid._options.getCellSize();

                    [cell00, cell01, cell10, cell11].forEach(function (element) {
                        assertEquals($(window).width() - 2 * peakAmount - cellSpacing, $(element).width());
                        assertEquals($(window).height() - 2 * peakAmount - cellSpacing, $(element).height());
                    });

                    this._grid.setSelectedCell({ column:0, row:0 });
                    assertCentered(cell00);

                    this._grid.setSelectedCell({ column:1, row:0 });
                    assertCentered(cell10);

                    this._grid.setSelectedCell({ column:0, row:1 });
                    assertCentered(cell01);

                    this._grid.setSelectedCell({ column:1, row:1 });
                    assertCentered(cell11);
                }
            }
        },

        testNotifyOnSetCellContent: function() {
            var oldCell = null, newCell = null;

            this._grid.setOptions({
                onCellContentChanged: function(e) {
                    oldCell = e.oldCell;
                    newCell = e.newCell;
                }
            });

            var cell1 = document.createElement("div");
            var cell2 = document.createElement("div");

            this._grid.setCellContent(0, 0, cell1);

            assertEquals(null, oldCell);
            assertEquals(cell1, newCell.content);

            this._grid.setCellContent(0, 0, cell2);

            assertEquals(cell1, oldCell.content);
            assertEquals(cell2, newCell.content);

        },

        testSelectCellOnClick: function() {
            var cell = document.createElement("div");
            this._grid.setCellContent(0, 0, cell);
            this._grid.selectCellOnClick();

            var dispatchMouseDown = function(target) {
                var event = document.createEvent("MouseEvent");
                event.initEvent("mousedown", true, true);
                target.dispatchEvent(event);
            };

            dispatchMouseDown(cell);

            assertEquals(cell, this._grid._selectedCell.content);

            var newCell = document.createElement("div");
            this._grid.setCellContent(1, 0, newCell);

            dispatchMouseDown(newCell);

            assertEquals(newCell, this._grid.getSelectedCell().content);

        },

        testSelectedCellShouldClearedIfCellIsRemoved: function() {
            var cell1 = document.createElement("div");
            var cell2 = document.createElement("div2");

            this._grid.setCellContent(0, 0, cell1);
            this._grid.setSelectedCell({ column: 0, row: 0 });
            assertEquals(cell1, this._grid.getSelectedCell().content);

            this._grid.setCellContent(0, 0, cell1);
            assertEquals(null, this._grid.getSelectedCell());
        }
    };

    function onTestsCompleted(result) {
        var grid = new Grid(document.body, { cellSpacing: 1 });
        var cell00 = document.createElement("div");
        var cell10 = document.createElement("div");
        var cell01 = document.createElement("div");
        var cell11 = document.createElement("div");

        cell00.style.background = "blue";
        cell10.style.background = "green";
        cell01.style.background = "yellow";
        cell11.style.background = "orange";

        grid.setCellContent(0, 0, cell00);
        grid.setCellContent(1, 0, cell10);
        grid.setCellContent(0, 1, cell01);
        grid.setCellContent(1, 1, cell11);

        grid.selectedCellVisible({ peakAmount: 15, move: move });
        grid.selectCellOnClick();
        grid.setSelectedCell({ column: 1, row: 1 });

        assertCentered(cell11);
    }
</script>
</body>
</html>